<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Δ = THE SUN</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    body { font-family: 'Courier New', monospace; background: #000; color: #0f0; text-align: center; padding: 2rem; }
    .card { background: #111; border: 1px solid #0f0; border-radius: 12px; padding: 2rem; max-width: 600px; margin: 2rem auto; }
    h1 { font-size: 2.5rem; margin: 0; }
    .symbol { font-size: 3rem; color: #0f0; }
    button { background: #0f0; color: #000; border: none; padding: 1rem 2rem; font-size: 1.2rem; border-radius: 8px; cursor: pointer; margin: 1rem; }
    button:disabled { background: #555; cursor: not-allowed; }
    .progress { width: 100%; height: 10px; background: #333; border-radius: 5px; margin: 1rem 0; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: #0f0; transition: width 0.3s; }
    pre { text-align: left; background: #222; padding: 1rem; border-radius: 8px; overflow: auto; }
    .result { font-size: 1.5rem; margin: 1rem; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="symbol">Δ = THE SUN</div>
    <h1>Solar Flare Predictor + Quantum CHSH</h1>
    <p>Download real HMI data, simulate quantum noise, predict X-class flares.</p>
    
    <button id="startBtn">Load Magnetogram + Collapse</button>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <pre id="code"></pre>
    <div id="result"></div>
  </div>

  <script type="text/javascript">
    let pyodide;
    async function main() {
      document.getElementById("startBtn").disabled = true;
      updateProgress(10);
      
      pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      
      updateProgress(30);
      await micropip.install("sunpy");
      await micropip.install("numpy");
      await micropip.install("qutip");
      
      updateProgress(50);
      const code = `
import numpy as np
from sunpy.net import Fido, attrs as a
import qutip as qt
import matplotlib.pyplot as plt
from js import document

# Step 1: Download HMI Magnetogram (X9.3 flare, 2017)
print("Downloading HMI magnetogram...")
result = Fido.search(
    a.Time('2017-09-06 11:00', '2017-09-06 13:00'),
    a.Instrument('hmi'), a.Physobs('los_magnetic_field')
)
files = Fido.fetch(result[0,0], path='./')
mag_map = sunpy.map.Map(files[0])

# Step 2: Crop active region
data = mag_map.data
data = np.nan_to_num(data)
x0, y0, size = 400, 200, 512
patch = data[y0:y0+size, x0:x0+size]

# Step 3: Extract features
flux = np.sum(np.abs(patch))
grad_x = np.gradient(patch, axis=0)
grad_y = np.gradient(patch, axis=1)
shear = np.mean(np.abs(grad_x + grad_y))

# Step 4: Quantum CHSH with noise
def amplitude_damping(rho, p):
    K0 = np.array([[1, 0], [0, np.sqrt(1-p)]])
    K1 = np.array([[0, np.sqrt(p)], [0, 0]])
    return K0 @ rho @ K0.T + K1 @ rho @ K1.T

psi = np.array([1, 0, 0, 1]) / np.sqrt(2)
rho = np.outer(psi, psi.conj())

gamma = 0.01
eps = 100
S_values = []
for t in range(eps):
    rho = amplitude_damping(rho, gamma)
    # CHSH expectation (simplified)
    S = 2 * np.sqrt(2) * np.abs(rho[0,3] + rho[0,3].conj())
    S_values.append(S.real)

final_S = S_values[-1]
flare_prob = min(99, flux / 1e20 * 100)  # dummy scaling

print(f"Final CHSH S: {final_S:.4f}")
print(f"Flux: {flux:.2e} Mx")
print(f"Shear: {shear:.2f}")
print(f"Flare Probability: {flare_prob:.1f}%")

[f"CHSH S = {final_S:.4f}", 
 f"Flux = {flux:.2e} Mx", 
 f"Shear = {shear:.2f}", 
 f"Flare Risk = {flare_prob:.1f}%",
 "QUANTUM LINK DECAYED" if final_S < 2 else "SPOOKY LINK SURVIVED"]
`;
      
      updateProgress(70);
      const result = await pyodide.runPythonAsync(code);
      const output = pyodide.globals.get("list");
      
      updateProgress(100);
      let html = "<pre>SIMULATION COMPLETE\n\n";
      output.forEach(line => html += line + "\\n");
      html += "</pre>";
      if (final_S < 2) {
        html += '<div class="result" style="color:#f00;">SPOOKY LINK BROKEN</div>';
      } else {
        html += '<div class="result" style="color:#0f0;">SPOOKY LINK SURVIVED</div>';
      }
      document.getElementById("result").innerHTML = html;
      document.getElementById("startBtn").disabled = false;
    }

    function updateProgress(pct) {
      document.getElementById("bar").style.width = pct + "%";
    }

    document.getElementById("startBtn").onclick = () => {
      document.getElementById("result").innerHTML = "";
      updateProgress(0);
      main();
    };

    // Auto-start
    main();
  </script>
</body>
</html>
