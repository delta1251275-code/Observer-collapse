<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Δ = THE OBSERVER</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding: 50px;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      font-size: 1.2em;
      margin: 8px 0;
    }
    button {
      background: #00f;
      color: #fff;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      margin: 20px 0;
    }
    button:disabled {
      background: #333;
      cursor: not-allowed;
    }
    #progress {
      width: 250px;
      height: 12px;
      background: #333;
      margin: 20px auto;
      border-radius: 6px;
      overflow: hidden;
    }
    #result {
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 1.1em;
      line-height: 1.6;
    }
    .pulse {
      animation: pulse 1.5s infinite;
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    #noise-slider {
      width: 250px;
      margin: 20px auto;
    }
    #noise-value {
      display: block;
      margin-top: 8px;
      font-family: monospace;
      color: #0f0;
    }
    .label {
      font-size: 1.1em;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Δ = THE OBSERVER</h1>
  <p>Live Bell-State CHSH simulation in a noisy cavity.</p>
  <p>Slide noise, then click to collapse the wavefunction.</p>
  
  <div class="label">Noise Level (gamma): <span id="noise-value">0.005</span></div>
  <input type="range" id="noise-slider" min="0" max="0.1" step="0.001" value="0.005">
  
  <div id="progress"></div>
  <button id="collapse">Collapse Now</button>
  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
  <script>
    async function main() {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("numpy");
      await pyodide.loadPackage("qutip");
      return pyodide;
    }
    let pyodideReadyPromise = main();

    // Slider update
    const slider = document.getElementById('noise-slider');
    const noiseValue = document.getElementById('noise-value');
    slider.addEventListener('input', () => {
      noiseValue.textContent = slider.value;
    });

    async function runSimulation() {
      const noise_level = parseFloat(slider.value);
      const progress = document.getElementById('progress');
      const button = document.getElementById('collapse');
      const resultDiv = document.getElementById('result');

      // Disable button
      button.disabled = true;
      button.textContent = "Running...";
      resultDiv.textContent = "";
      resultDiv.classList.remove('pulse');

      // Progress bar
      let width = 0;
      const interval = setInterval(() => {
        width = (width + 2) % 101;
        progress.style.background = `linear-gradient(to right, #00f ${width}%, #333 ${width}%)`;
      }, 50);

      try {
        let pyodide = await pyodideReadyPromise;
        let pythonCode = `
import qutip as qt
import numpy as np
from numpy.random import choice

def get_projectors(M):
    e, v = M.eigenstates()
    Pplus = v[1] * v[1].dag() if e[1] == 1 else v[0] * v[0].dag()
    Pminus = v[0] * v[0].dag() if e[1] == 1 else v[1] * v[1].dag()
    return Pplus, Pminus

def get_correlation(rho, M1, M2, trials):
    P1p, P1m = get_projectors(M1)
    P2p, P2m = get_projectors(M2)
    p_pp = (qt.tensor(P1p, P2p) * rho).tr().real
    p_pm = (qt.tensor(P1p, P2m) * rho).tr().real
    p_mp = (qt.tensor(P1m, P2p) * rho).tr().real
    p_mm = (qt.tensor(P1m, P2m) * rho).tr().real
    total = p_pp + p_pm + p_mp + p_mm
    if total > 0:
        p_pp /= total; p_pm /= total; p_mp /= total; p_mm /= total
    outcomes = choice(['++', '+-', '-+', '--'], size=trials, p=[p_pp, p_pm, p_mp, p_mm])
    corr = (np.sum(outcomes == '++') + np.sum(outcomes == '--') - np.sum(outcomes == '+-') - np.sum(outcomes == '-+')) / trials
    return corr

def compute_chsh(rho, num_trials=5000):
    def meas_op(theta):
        return np.cos(theta) * qt.sigmaz() + np.sin(theta) * qt.sigmax()
    A = meas_op(0)
    Ap = meas_op(np.pi/2)
    B = meas_op(np.pi/4)
    Bp = meas_op(-np.pi/4)
    trials_per = num_trials // 4
    ab = get_correlation(rho, A, B, trials_per)
    abp = get_correlation(rho, A, Bp, trials_per)
    apb = get_correlation(rho, Ap, B, trials_per)
    apbp = get_correlation(rho, Ap, Bp, trials_per)
    return ab + abp + apb - apbp

# Initial Bell state
psi0 = qt.bell_state('00')
rho0 = psi0 * psi0.dag()
H = qt.Qobj(np.zeros((4,4)), dims=[[2,2],[2,2]])

# Noise from slider
gamma = ${noise_level}
c_ops = [
    np.sqrt(gamma) * qt.tensor(qt.sigmam(), qt.qeye(2)),
    np.sqrt(gamma) * qt.tensor(qt.qeye(2), qt.sigmam())
]

# Longer evolution = more realistic decay
tlist = np.linspace(0, 10, 100)
result = qt.mesolve(H, rho0, tlist, c_ops)
rho = result.states[-1]

s = compute_chsh(rho)
ideal = 2 * np.sqrt(2)
loss = (ideal - abs(s)) / ideal * 100

output = f"CHSH S = {s:.4f} (max 2.828, classical ≤2)\\n"
output += f"Noise Impact: {loss:.1f}% loss\\n\\n"
output += "SPOOKY LINK SURVIVED" if abs(s) > 2 else "SPOOKY LINK BROKEN"
print(output)
`;
        let output = await pyodide.runPython(pythonCode);
        clearInterval(interval);
        progress.style.background = '#333';
        resultDiv.innerText = output;
        if (Math.abs(parseFloat(output.split('\\n')[0].split('=')[1])) > 2) {
          resultDiv.classList.add('pulse');
        }
      } catch (err) {
        resultDiv.innerText = "Error: " + err.message;
      } finally {
        button.textContent = "Collapse Again";
        button.disabled = false;
      }
    }

    document.getElementById('collapse').addEventListener('click', runSimulation);
  </script>
</body>
</html>
